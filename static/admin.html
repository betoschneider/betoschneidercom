<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>Admin - Meus Projetos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="container">
    <h1>Gerenciar Projetos</h1>

    <div class="project-card" style="border-color: var(--primary-color);">
      <div class="form-group">
        <label for="token">Token Admin</label>
        <input id="token" type="password" placeholder="Insira o token admin" />
      </div>
    </div>

    <h2>Criar / Editar Projeto</h2>
    <div class="project-card" style="border-color: var(--primary-color);">
      <div class="form-group">
        <input id="title" type="text" placeholder="Título do Projeto" />
      </div>
      <div class="form-group">
        <textarea id="description" placeholder="Descrição do Projeto"></textarea>
      </div>
      <div class="form-group">
        <input id="url" type="text" placeholder="URL (https://...)" />
      </div>
      <div class="form-group">
        <input id="repo_url" type="text" placeholder="URL do Repositório (Opcional)" />
      </div>
      <div style="display: flex; gap: 10px;">
        <button id="createBtn">Criar Projeto</button>
        <button id="updateBtn" disabled class="secondary">Atualizar</button>
        <button id="clearBtn" class="secondary"
          style="background: transparent; color: #6c757d; border: 1px solid #dee2e6;">Limpar</button>
      </div>
    </div>

    <a href="/" class="nav-link" style="margin-top: 0; margin-bottom: 20px;">← Voltar para página pública</a>

    <h2>Estatísticas de Acesso (Últimos 90 dias)</h2>
    <div style="margin-bottom: 10px;">
      <button id="loadStatsBtn" class="secondary" style="padding: 5px 10px; font-size: 0.9em;">Carregar / Atualizar
        Estatísticas</button>
    </div>

    <div id="statsContainer" class="project-card" style="border-color: var(--primary-color); display: none;">
      <table style="width: 100%; border-collapse: collapse; text-align: left;">
        <thead>
          <tr style="border-bottom: 1px solid #dee2e6;">
            <th style="padding: 8px;">Data</th>
            <th style="padding: 8px;">Total</th>
            <th style="padding: 8px;">PC</th>
            <th style="padding: 8px;">Smartphone</th>
          </tr>
        </thead>
        <tbody id="statsTableBody">
          <tr>
            <td colspan="4" style="text-align: center; padding: 10px;">Carregando estatísticas...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <h2>Lista de Projetos</h2>
    <div id="projectsList">
      <p style="text-align: center; color: #6c757d;">Carregando...</p>
    </div>

    <a href="/" class="nav-link">← Voltar para página pública</a>
    <footer>
      Desenvolvido por <a href="https://www.linkedin.com/in/robertoschneider/" target="_blank">Roberto Schneider</a>.
      2025. | <a href="https://github.com/betoschneider" target="_blank">GitHub</a>
    </footer>
  </div>

  <script src="/static/js/app.js"></script>
  <script>
    // Override loadProjectsForAdmin to use new classes
    const originalLoadProjectsForAdmin = loadProjectsForAdmin;
    loadProjectsForAdmin = async function () {
      const projects = await fetchProjects();
      const root = document.getElementById('projectsList');
      if (!projects || projects.length === 0) {
        root.innerHTML = '<p style="text-align: center;">Nenhum projeto encontrado.</p>';
        return;
      }
      root.innerHTML = '';
      projects.forEach(p => {
        const div = document.createElement('div');
        div.className = 'project';
        div.innerHTML = `
          <span class="project-title">${escapeHtml(p.title)}</span>
          <p class="project-desc">${escapeHtml(p.description || '')}</p>
          <p><a href="${p.url}" target="_blank" style="font-size: 0.9rem;">${p.url}</a></p>
          ${p.repo_url ? `<p><a href="${p.repo_url}" target="_blank" style="font-size: 0.9rem;">Repo: ${p.repo_url}</a></p>` : ''}
          <div class="admin-controls">
            <button data-id="${p.id}" class="edit secondary" style="padding: 6px 12px; font-size: 0.9rem;">Editar</button>
            <button data-id="${p.id}" class="delete" style="padding: 6px 12px; font-size: 0.9rem;">Apagar</button>
          </div>
        `;
        root.appendChild(div);
      });

      // Re-attach event listeners (logic copied from app.js but adapted for new DOM elements if needed)
      // Since we replaced innerHTML, we need to attach listeners to the new buttons
      root.querySelectorAll('.edit').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.dataset.id; fillFormForEdit(id);
        // Scroll to form
        document.getElementById('title').scrollIntoView({ behavior: 'smooth' });
      }));
      root.querySelectorAll('.delete').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        const token = document.getElementById('token').value.trim();
        if (!token) { alert('Por favor, insira o Token Admin primeiro.'); return; }
        if (!confirm('Tem certeza que deseja excluir este projeto?')) return;
        await deleteProjectById(id, token);
        await loadProjectsForAdmin();
      }));
    };

    // admin init
    (async function () {
      await initAdmin();

      // Setup stats button
      const loadStatsBtn = document.getElementById('loadStatsBtn');
      if (loadStatsBtn) {
        loadStatsBtn.addEventListener('click', loadStats);
      }
    })();

    async function loadStats() {
      const token = document.getElementById('token').value.trim();
      if (!token) {
        alert('Por favor, insira o token admin para ver as estatísticas.');
        return;
      }

      const tbody = document.getElementById('statsTableBody');
      const container = document.getElementById('statsContainer');

      try {
        const res = await fetch('/admin/stats', {
          headers: { 'X-Admin-Token': token }
        });

        if (!res.ok) {
          if (res.status === 401) throw new Error('Token inválido');
          throw new Error('Erro ao carregar dados');
        }

        const data = await res.json();

        // Show container on success
        container.style.display = 'block';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 10px;">Nenhuma visita registrada nos últimos 90 dias.</td></tr>';
          return;
        }

        tbody.innerHTML = data.sort((a, b) => b.date.localeCompare(a.date)).map(row => `
          <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 8px;">${row.date.split('-').reverse().join('/')}</td>
            <td style="padding: 8px; font-weight: bold;">${row.total}</td>
            <td style="padding: 8px; color: #666;">${row.pc}</td>
            <td style="padding: 8px; color: #666;">${row.smartphone}</td>
          </tr>
        `).join('');

      } catch (err) {
        alert(err.message);
        // Ensure it stays hidden or hide it if it was visible? 
        // Let's keep previous state or hide? User wants it hidden until verified.
        // If error, likely token is wrong, so maybe hide it.
        container.style.display = 'none';
      }
    }

    // Changing approach: adding logic to `initAdmin` to handle stats loading button.
  </script>
</body>

</html>