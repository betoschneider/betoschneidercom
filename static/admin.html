<!doctype html>
<html lang="pt-BR">

<head>
  <meta charset="utf-8" />
  <title>Admin - Meus Projetos</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="/static/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
  <div class="container">
    <h1>Painel Admin</h1>

    <div class="project-card" style="border-color: var(--primary-color);">
      <div class="form-group">
        <label for="token">Token Admin</label>
        <input id="token" type="password" placeholder="Insira o Token Admin para autenticar" />
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="openTab('projects-tab')">Gerenciar Projetos</button>
      <button class="tab-btn" onclick="openTab('profile-tab')">Editar Perfil</button>
      <button class="tab-btn" onclick="openTab('stats-tab')">Estatísticas</button>
    </div>

    <!-- Tab Projects -->
    <div id="projects-tab" class="tab-content active">
      <h2>Criar / Editar Projeto</h2>
      <div class="project-card" style="border-color: var(--border-color);">
        <div class="form-group">
          <input id="title" type="text" placeholder="Título do Projeto" />
        </div>
        <div class="form-group">
          <textarea id="description" placeholder="Descrição do Projeto"></textarea>
        </div>
        <div class="form-group">
          <input id="url" type="text" placeholder="URL (https://...)" />
        </div>
        <div class="form-group">
          <input id="repo_url" type="text" placeholder="URL do Repositório (Opcional)" />
        </div>
        <div style="display: flex; gap: 10px;">
          <button id="createBtn">Criar Projeto</button>
          <button id="updateBtn" disabled class="secondary">Atualizar</button>
          <button id="clearBtn" class="secondary"
            style="background: transparent; color: #6c757d; border: 1px solid #dee2e6;">Limpar</button>
        </div>
      </div>

      <h2>Lista de Projetos</h2>
      <div id="projectsList">
        <p style="text-align: center; color: #6c757d;">Carregando...</p>
      </div>
    </div>

    <!-- Tab Profile -->
    <div id="profile-tab" class="tab-content">
      <h2>Editar Perfil (Hero Section)</h2>
      <div class="project-card" style="border-color: var(--border-color);">
        <div class="form-group">
          <label>Nome Completo</label>
          <input id="p_name" type="text" />
        </div>
        <div class="form-group">
          <label>Cargo / Headline</label>
          <input id="p_role" type="text" />
        </div>
        <div class="form-group">
          <label>Localização</label>
          <input id="p_location" type="text" />
        </div>
        <div class="form-group">
          <label>Bio / Descrição</label>
          <textarea id="p_description" style="min-height: 150px;"></textarea>
        </div>
        <div class="form-group">
          <label>Stacks (separadas por vírgula)</label>
          <input id="p_stacks" type="text" placeholder="Python, JavaScript, SQL..." />
        </div>
        <div class="form-group">
          <label>URL da Foto de Perfil</label>
          <input id="p_photo_url" type="text" placeholder="https://..." />
        </div>
        <div class="form-group">
          <label>LinkedIn URL</label>
          <input id="p_linkedin" type="text" />
        </div>
        <div class="form-group">
          <label>GitHub URL</label>
          <input id="p_github" type="text" />
        </div>
        <button id="saveProfileBtn">Salvar Perfil</button>
      </div>
    </div>

    <!-- Tab Stats -->
    <div id="stats-tab" class="tab-content">
      <h2>Estatísticas de Acesso (Últimos 90 dias)</h2>
      <div style="margin-bottom: 20px;">
        <button id="loadStatsBtn" class="secondary">Carregar Estatísticas</button>
      </div>

      <div id="statsContainer" class="project-card" style="border-color: var(--border-color); display: none;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
          <thead>
            <tr style="border-bottom: 1px solid #dee2e6;">
              <th style="padding: 8px;">Data</th>
              <th style="padding: 8px;">Total</th>
              <th style="padding: 8px;">PC</th>
              <th style="padding: 8px;">Smartphone</th>
            </tr>
          </thead>
          <tbody id="statsTableBody">
            <tr>
              <td colspan="4" style="text-align: center; padding: 10px;">Carregando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <a href="/" class="nav-link">← Voltar para página pública</a>
    <footer>
      Desenvolvido por <a href="https://www.linkedin.com/in/robertoschneider/" target="_blank">Roberto Schneider</a>.
      2025. | <a href="https://github.com/betoschneider" target="_blank">GitHub</a>
    </footer>
  </div>

  <script src="/static/js/app.js"></script>
  <script>
    // Tab Logic
    function openTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active'); // Assumes button is clicked
    }

    // Profile Logic
    async function loadProfileForAdmin() {
      try {
        const res = await fetch('/profile');
        const p = await res.json();

        document.getElementById('p_name').value = p.name || '';
        document.getElementById('p_role').value = p.role || '';
        document.getElementById('p_location').value = p.location || '';
        document.getElementById('p_description').value = p.description || '';
        document.getElementById('p_stacks').value = p.stacks || '';
        document.getElementById('p_photo_url').value = p.photo_url || '';
        document.getElementById('p_linkedin').value = p.social_linkedin || '';
        document.getElementById('p_github').value = p.social_github || '';
      } catch (e) {
        console.error("Erro ao carregar perfil", e);
      }
    }

    async function saveProfile() {
      const token = document.getElementById('token').value.trim();
      if (!token) {
        alert('Insira o Token Admin');
        return;
      }

      const data = {
        name: document.getElementById('p_name').value,
        role: document.getElementById('p_role').value,
        location: document.getElementById('p_location').value,
        description: document.getElementById('p_description').value,
        stacks: document.getElementById('p_stacks').value,
        photo_url: document.getElementById('p_photo_url').value,
        social_linkedin: document.getElementById('p_linkedin').value,
        social_github: document.getElementById('p_github').value
      };

      try {
        const res = await fetch('/profile', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'X-Admin-Token': token
          },
          body: JSON.stringify(data)
        });

        if (res.ok) {
          alert('Perfil atualizado com sucesso!');
        } else {
          alert('Erro ao atualizar perfil. Verifique o token.');
        }
      } catch (e) {
        alert('Erro ao conectar com API.');
        console.error(e);
      }
    }


    // Override loadProjectsForAdmin to use new classes
    const originalLoadProjectsForAdmin = loadProjectsForAdmin;
    loadProjectsForAdmin = async function () {
      const projects = await fetchProjects();
      const root = document.getElementById('projectsList');
      if (!projects || projects.length === 0) {
        root.innerHTML = '<p style="text-align: center;">Nenhum projeto encontrado.</p>';
        return;
      }
      root.innerHTML = '';
      projects.forEach(p => {
        const div = document.createElement('div');
        div.className = 'project';
        div.innerHTML = `
          <span class="project-title">${escapeHtml(p.title)}</span>
          <p class="project-desc">${escapeHtml(p.description || '')}</p>
          <p><a href="${p.url}" target="_blank" style="font-size: 0.9rem;">${p.url}</a></p>
          ${p.repo_url ? `<p><a href="${p.repo_url}" target="_blank" style="font-size: 0.9rem;">Repo: ${p.repo_url}</a></p>` : ''}
          <div class="admin-controls">
            <button data-id="${p.id}" class="edit secondary" style="padding: 6px 12px; font-size: 0.9rem;">Editar</button>
            <button data-id="${p.id}" class="delete" style="padding: 6px 12px; font-size: 0.9rem;">Apagar</button>
          </div>
        `;
        root.appendChild(div);
      });

      // Re-attach event listeners (logic copied from app.js but adapted for new DOM elements if needed)
      // Since we replaced innerHTML, we need to attach listeners to the new buttons
      root.querySelectorAll('.edit').forEach(btn => btn.addEventListener('click', e => {
        const id = e.target.dataset.id; fillFormForEdit(id);
        // Scroll to form
        document.getElementById('title').scrollIntoView({ behavior: 'smooth' });
      }));
      root.querySelectorAll('.delete').forEach(btn => btn.addEventListener('click', async e => {
        const id = e.target.dataset.id;
        const token = document.getElementById('token').value.trim();
        if (!token) { alert('Por favor, insira o Token Admin primeiro.'); return; }
        if (!confirm('Tem certeza que deseja excluir este projeto?')) return;
        await deleteProjectById(id, token);
        await loadProjectsForAdmin();
      }));
    };

    // admin init
    (async function () {
      await initAdmin();
      loadProfileForAdmin();

      document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);

      // Setup stats button
      const loadStatsBtn = document.getElementById('loadStatsBtn');
      if (loadStatsBtn) {
        loadStatsBtn.addEventListener('click', loadStats);
      }
    })();

    async function loadStats() {
      const token = document.getElementById('token').value.trim();
      if (!token) {
        alert('Por favor, insira o token admin para ver as estatísticas.');
        return;
      }

      const tbody = document.getElementById('statsTableBody');
      const container = document.getElementById('statsContainer');

      try {
        const res = await fetch('/admin/stats', {
          headers: { 'X-Admin-Token': token }
        });

        if (!res.ok) {
          if (res.status === 401) throw new Error('Token inválido');
          throw new Error('Erro ao carregar dados');
        }

        const data = await res.json();

        // Show container on success
        container.style.display = 'block';

        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 10px;">Nenhuma visita registrada nos últimos 90 dias.</td></tr>';
          return;
        }

        tbody.innerHTML = data.sort((a, b) => b.date.localeCompare(a.date)).map(row => `
          <tr style="border-bottom: 1px solid #eee;">
            <td style="padding: 8px;">${row.date.split('-').reverse().join('/')}</td>
            <td style="padding: 8px; font-weight: bold;">${row.total}</td>
            <td style="padding: 8px; color: #666;">${row.pc}</td>
            <td style="padding: 8px; color: #666;">${row.smartphone}</td>
          </tr>
        `).join('');

      } catch (err) {
        alert(err.message);
        container.style.display = 'none';
      }
    }
  </script>
</body>

</html>